# nginx/nginx.conf

# Define a dónde apuntan nuestros servicios de backend
upstream auth_service { server auth-service:4001; }
upstream restaurant_service { server restaurant-service:4002; }
upstream payment_service { server payment-service:4003; }
upstream pos_service { server pos-service:4004; }
upstream pac_service { server pac-service:4005; }

# Servidor para redirigir todo el tráfico de HTTP a HTTPS
server {
    listen 80;
    server_name nextmanager.com.mx www.nextmanager.com.mx;
    return 301 https://$host$request_uri;
}

# Servidor principal para HTTPS
server {
    listen 443 ssl http2;
    server_name nextmanager.com.mx www.nextmanager.com.mx;

    # Certificados SSL (leídos desde el volumen montado)
    ssl_certificate /etc/letsencrypt/live/nextmanager.com.mx/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/nextmanager.com.mx/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # --- REGLAS DE ENRUTAMIENTO (PROXY) ---
    location /api/auth {
        proxy_pass http://auth_service;
    }
    location /api/restaurants {
        proxy_pass http://restaurant_service;
    }
    location /api/payments {
        proxy_pass http://payment_service;
    }
    location /api/pos {
        proxy_pass http://pos_service;
    }
    location /api/pac {
        proxy_pass http://pac_service;
    }

    # --- SIRVE EL FRONTEND DE REACT ---
    location / {
        root /var/www/html;
        try_files $uri /index.html;
    }
}
